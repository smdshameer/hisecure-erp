// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}





model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  role      String     @default("CASHIER")
  branch    String?
  gstin     String?
  state     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  sales     Sale[]
  tickets   ServiceTicket[]
  interactions Interaction[]
  assignedFollowUps FollowUp[]
}

model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String
  email     String?
  address   String?
  gstin     String?
  state     String?
  segment   String?
  notes     String?
  createdAt DateTime @default(now())
  
  sales     Sale[]
  tickets   ServiceTicket[]
  interactions Interaction[]
  followUps    FollowUp[]
  complaints   Complaint[]
  quotations   Quotation[]
}

model Product {
  id             Int      @id @default(autoincrement())
  sku            String   @unique
  name           String
  description    String?
  category       String?
  price          Decimal
  costPrice      Decimal
  stockQuantity  Int      @default(0)
  lowStockThreshold Int   @default(5)
  hsnCode        String?
  gstRate        Decimal  @default(0)
  imageUrl       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  saleItems      SaleItem[]
  ticketParts    TicketPart[]
  purchaseItems  PurchaseOrderItem[]
  quotationItems QuotationItem[]
  warrantyMonths Int      @default(0) // 0 means no warranty

  branchStocks   BranchStock[]
  stockTransfers StockTransfer[]

  autoReorder    Boolean  @default(false)
  reorderQuantity Int     @default(10)
}

model Sale {
  id          Int      @id @default(autoincrement())
  invoiceNo   String   @unique
  subTotal    Decimal  @default(0)
  cgst        Decimal  @default(0)
  sgst        Decimal  @default(0)
  igst        Decimal  @default(0)
  totalAmount Decimal
  paymentMethod String
  createdAt   DateTime @default(now())
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  customerId  Int?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  items       SaleItem[]
}

model SaleItem {
  id        Int      @id @default(autoincrement())
  quantity  Int
  price     Decimal
  
  saleId    Int
  sale      Sale     @relation(fields: [saleId], references: [id])
  
  productId Int
  product   Product  @relation(fields: [productId], references: [id])

  warrantyClaims WarrantyClaim[]
}

model ServiceTicket {
  id          Int      @id @default(autoincrement())
  description String
  status      String @default("OPEN")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  customerId  Int
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  technicianId Int?
  technician   User?    @relation(fields: [technicianId], references: [id])
  
  parts       TicketPart[]
}

model TicketPart {
  id        Int      @id @default(autoincrement())
  quantity  Int
  
  ticketId  Int
  ticket    ServiceTicket @relation(fields: [ticketId], references: [id])
  
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
}



model Enquiry {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  phone     String
  message   String
  status    String @default("NEW")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Supplier {
  id        Int      @id @default(autoincrement())
  name      String
  contactPerson String?
  email     String?
  phone     String?
  address   String?
  gstin     String?
  state     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
}



model PurchaseOrder {
  id          Int      @id @default(autoincrement())
  poNumber    String   @unique
  status      String @default("DRAFT")
  subTotal    Decimal  @default(0)
  cgst        Decimal  @default(0)
  sgst        Decimal  @default(0)
  igst        Decimal  @default(0)
  totalAmount Decimal
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  supplierId  Int
  supplier    Supplier @relation(fields: [supplierId], references: [id])

  items       PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id        Int      @id @default(autoincrement())
  quantity  Int
  unitCost  Decimal

  purchaseOrderId Int
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  productId Int
  product   Product @relation(fields: [productId], references: [id])
}



model WarrantyClaim {
  id          Int      @id @default(autoincrement())
  description String
  status      String @default("PENDING")
  resolution  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  saleItemId  Int
  saleItem    SaleItem @relation(fields: [saleItemId], references: [id])
}

// GST Compliance Additions
model GSTConfig {
  id          Int      @id @default(autoincrement())
  gstin       String?
  state       String?  // Business State for tax calculation
  updatedAt   DateTime @updatedAt
}

model Branch {
  id            Int      @id @default(autoincrement())
  name          String
  location      String
  contactPerson String?
  phone         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  stocks        BranchStock[]
  sourceTransfers StockTransfer[] @relation("SourceBranch")
  targetTransfers StockTransfer[] @relation("TargetBranch")
}

model BranchStock {
  id        Int      @id @default(autoincrement())
  quantity  Int      @default(0)
  
  branchId  Int
  branch    Branch   @relation(fields: [branchId], references: [id])
  
  productId Int
  product   Product  @relation(fields: [productId], references: [id])

  @@unique([branchId, productId])
}



model StockTransfer {
  id             Int      @id @default(autoincrement())
  quantity       Int
  status         String @default("COMPLETED") // Immediate transfer for now
  createdAt      DateTime @default(now())
  
  productId      Int
  product        Product  @relation(fields: [productId], references: [id])

  // Null source/target means Main Warehouse
  sourceBranchId Int?
  sourceBranch   Branch?  @relation("SourceBranch", fields: [sourceBranchId], references: [id])
  
  targetBranchId Int?
  targetBranch   Branch?  @relation("TargetBranch", fields: [targetBranchId], references: [id])
}

// CRM Module Additions



model Interaction {
  id        Int      @id @default(autoincrement())
  type      String
  notes     String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  customerId Int
  customer   Customer @relation(fields: [customerId], references: [id])
}



model FollowUp {
  id          Int      @id @default(autoincrement())
  date        DateTime
  description String
  status      String @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customerId  Int
  customer    Customer @relation(fields: [customerId], references: [id])

  assignedToId Int?
  assignedTo   User? @relation(fields: [assignedToId], references: [id])
}





model Complaint {
  id          Int      @id @default(autoincrement())
  subject     String
  description String
  status      String @default("OPEN")
  priority    String @default("MEDIUM")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customerId  Int
  customer    Customer @relation(fields: [customerId], references: [id])
}

model Quotation {
  id          Int      @id @default(autoincrement())
  quotationNo String   @unique
  status      String   @default("DRAFT") // DRAFT, SENT, ACCEPTED, REJECTED
  subTotal    Decimal  @default(0)
  cgst        Decimal  @default(0)
  sgst        Decimal  @default(0)
  igst        Decimal  @default(0)
  totalAmount Decimal
  validUntil  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  customerId  Int
  customer    Customer @relation(fields: [customerId], references: [id])
  
  items       QuotationItem[]
}

model QuotationItem {
  id        Int      @id @default(autoincrement())
  quantity  Int
  unitPrice Decimal
  
  quotationId Int
  quotation   Quotation @relation(fields: [quotationId], references: [id])
  
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
}
